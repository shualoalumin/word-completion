name: Discord Notification

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CF_PROJECT: ${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}
      CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: Verify and Sanitize Secrets (Python)
        shell: python
        run: |
          import os

          def clean(val):
              return val.strip() if val else ""

          cf_id = clean("""${{ secrets.CLOUDFLARE_ACCOUNT_ID }}""")
          cf_proj = clean("""${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}""")
          cf_token = clean("""${{ secrets.CLOUDFLARE_API_TOKEN }}""")
          discord_url = clean("""${{ secrets.DISCORD_WEBHOOK_URL }}""")

          # Debugging Helper: ÌÜ†ÌÅ∞Ïùò ÌòïÌÉú ÌôïÏù∏ (Î≥¥ÏïàÏùÑ ÏúÑÌï¥ ÏïûÎí§Îßå ÏÇ¥Ïßù ÎÖ∏Ï∂ú)
          if cf_token:
              masked = f"{cf_token[:3]}...{cf_token[-3:]}" if len(cf_token) > 6 else "***"
              print(f"DEBUG: Token Length: {len(cf_token)}, Format: {masked}")
              if cf_token.lower().startswith("bearer"):
                  print("‚ö†Ô∏è WARNING: SecretÏóê 'Bearer'ÎùºÎäî Í∏ÄÏûêÍ∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§. Ïù¥Î•º Ï†úÍ±∞ÌïòÍ≥† ÌÜ†ÌÅ∞ Î¨∏ÏûêÏó¥Îßå ÎÑ£Ïñ¥Ïïº Ìï©ÎãàÎã§.")

          # Save to Env
          with open(os.environ["GITHUB_ENV"], "a") as f:
              f.write(f"CF_ACCOUNT_ID={cf_id}\n")
              f.write(f"CF_PROJECT={cf_proj}\n")
              f.write(f"CF_TOKEN={cf_token}\n")
              f.write(f"DISCORD_WEBHOOK={discord_url}\n")

          print("‚úÖ Secrets Sanitized.")

      - name: Token Diagnostics
        run: |
          echo "üîç Testing token with Cloudflare API..."
          # Bearer ÌÜ†ÌÅ∞ Ïù∏Ï¶ù ÏãúÎèÑ
          VERIFY=$(curl -s -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" \
            -H "Authorization: Bearer $CF_TOKEN" \
            -H "Content-Type: application/json")

          echo "Cloudflare Response: $VERIFY"

          if [[ $VERIFY == *"\"status\":\"active\""* ]]; then
            echo "‚úÖ ÌÜ†ÌÅ∞Ïù¥ ÌôúÏÑ± ÏÉÅÌÉúÏûÖÎãàÎã§!"
          else
            echo "‚ùå Ïó¨Ï†ÑÌûà ÌÜ†ÌÅ∞ Ïò§Î•òÏûÖÎãàÎã§. ÌÜ†ÌÅ∞ ÏÉùÏÑ± Ïãú 'Account.Cloudflare Pages' Í∂åÌïúÏù¥ ÏûàÎäîÏßÄ, IP Ï†úÌïúÏù¥ ÏóÜÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî."
            exit 1
          fi

      - name: Poll Deployment Status
        id: poll
        shell: bash
        run: |
          set +e
          API_BASE="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PROJECT}"

          echo "üîç Accessing project: $CF_PROJECT"
          DETAILS=$(curl -s -X GET "$API_BASE/deployments?per_page=1" \
            -H "Authorization: Bearer $CF_TOKEN")

          if [[ $DETAILS == *"\"success\":false"* ]]; then
            echo "‚ùå API Ìò∏Ï∂ú Ïã§Ìå®. Response: $DETAILS"
            exit 1
          fi

          DEPLOY_ID=$(echo "$DETAILS" | jq -r '.result[0].id')
          echo "üìå Tracking Deployment ID: $DEPLOY_ID"

          for i in {1..30}; do
            STATUS_RESP=$(curl -s -X GET "$API_BASE/deployments/$DEPLOY_ID" -H "Authorization: Bearer $CF_TOKEN")
            STATUS_VAL=$(echo "$STATUS_RESP" | jq -r '.result.latest_stage.status')
            URL_VAL=$(echo "$STATUS_RESP" | jq -r '.result.url')
            echo "   Status ($i/30): $STATUS_VAL"
            
            if [[ "$STATUS_VAL" == "success" || "$STATUS_VAL" == "failure" ]]; then
              echo "STATUS=$STATUS_VAL" >> $GITHUB_ENV
              echo "DEPLOY_URL=$URL_VAL" >> $GITHUB_ENV
              exit 0
            fi
            sleep 10
          done
          echo "STATUS=timeout" >> $GITHUB_ENV

      - name: Send Discord Notification
        if: always()
        run: |
          # Use Environment Variables safely
          COMMIT_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)

          python3 -c '
          import os, json, requests

          status = os.environ.get("STATUS", "error")
          color = 5763719 if status == "success" else 15548997
          title = "‚úÖ Î∞∞Ìè¨ ÏÑ±Í≥µ" if status == "success" else "‚ùå Î∞∞Ìè¨ Ïã§Ìå®/Ïò§Î•ò"

          payload = {
              "username": "Cloudflare Pages",
              "avatar_url": "https://brand.cloudflare.com/static/assets/logos/pages-icon-blue.png",
              "embeds": [{
                  "title": title,
                  "color": color,
                  "url": os.environ.get("DEPLOY_URL", ""),
                  "fields": [
                      {"name": "Project", "value": os.environ.get("CF_PROJECT", "N/A"), "inline": True},
                      {"name": "Commit", "value": "'$COMMIT_SHORT'", "inline": True},
                      {"name": "Author", "value": "${{ github.actor }}", "inline": True},
                      {"name": "Status", "value": status, "inline": True}
                  ],
                  "footer": {"text": "Via GitHub Actions (Python Sanitized)"}
              }]
          }
          requests.post(os.environ["DISCORD_WEBHOOK"], json=payload)
          '
