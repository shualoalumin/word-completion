name: Discord Notification

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CF_PROJECT: ${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}
      CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: Verify and Sanitize
        run: |
          # Use secrets directly to ensure we have values (avoiding empty env var issues)
          ID_CLEAN=$(echo '${{ secrets.CLOUDFLARE_ACCOUNT_ID }}' | xargs)
          PROJ_CLEAN=$(echo '${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}' | xargs)
          TOKEN_CLEAN=$(echo '${{ secrets.CLOUDFLARE_API_TOKEN }}' | xargs)
          WEBHOOK_CLEAN=$(echo '${{ secrets.DISCORD_WEBHOOK_URL }}' | xargs)

          if [ -z "$ID_CLEAN" ]; then
            echo "‚ùå ERROR: CLOUDFLARE_ACCOUNT_ID secret is EMPTY in GitHub Settings!"
            echo "Please add it to Settings > Secrets and variables > Actions."
            exit 1
          fi

          echo "CF_ACCOUNT_ID=$ID_CLEAN" >> $GITHUB_ENV
          echo "CF_PROJECT=$PROJ_CLEAN" >> $GITHUB_ENV
          echo "CF_TOKEN=$TOKEN_CLEAN" >> $GITHUB_ENV
          echo "DISCORD_WEBHOOK=$WEBHOOK_CLEAN" >> $GITHUB_ENV

      - name: Token Diagnostics
        run: |
          echo "üîç Checking Cloudflare Token validity..."
          VERIFY=$(curl -s -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" \
            -H "Authorization: Bearer $CF_TOKEN" \
            -H "Content-Type: application/json")

          if [[ $VERIFY != *"\"status\":\"active\""* ]]; then
            echo "‚ùå ÌÜ†ÌÅ∞ Ïù∏Ï¶ù Ïã§Ìå®! Response: $VERIFY"
            exit 1
          fi
          echo "‚úÖ Token is active."

      - name: Wait for Cloudflare
        run: sleep 30

      - name: Poll Deployment Status
        id: poll
        shell: bash
        run: |
          set +e
          if [ -z "$CF_ACCOUNT_ID" ]; then echo "‚ùå CF_ACCOUNT_ID is empty!"; exit 1; fi

          API_BASE="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PROJECT}"
          echo "üîç Accessing: $API_BASE"

          DETAILS=$(curl -s -X GET "$API_BASE/deployments?per_page=1" \
            -H "Authorization: Bearer $CF_TOKEN")

          if [[ $DETAILS == *"\"success\":false"* ]]; then
            echo "‚ùå ÌîÑÎ°úÏ†ùÌä∏ Ï†ëÍ∑º Í±∞Î∂Ä (403)! Í≥ÑÏ†ï IDÍ∞Ä ÎßûÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî."
            echo "API Response: $DETAILS"
            exit 1
          fi

          DEPLOY_ID=$(echo "$DETAILS" | jq -r '.result[0].id')
          if [ "$DEPLOY_ID" == "null" ]; then
            echo "‚ùå No deployments found for this project."
            exit 1
          fi
          echo "üìå Tracking Deployment ID: $DEPLOY_ID"

          # Poll for 5 minutes (30 * 10s)
          for i in {1..30}; do
            STATUS_RESP=$(curl -s -X GET "$API_BASE/deployments/$DEPLOY_ID" -H "Authorization: Bearer $CF_TOKEN")
            STATUS=$(echo "$STATUS_RESP" | jq -r '.result.latest_stage.status')
            URL=$(echo "$STATUS_RESP" | jq -r '.result.url')
            echo "   Current Status ($i/30): $STATUS"
            
            if [[ "$STATUS" == "success" || "$STATUS" == "failure" ]]; then
              echo "STATUS=$STATUS" >> $GITHUB_ENV
              echo "DEPLOY_URL=$URL" >> $GITHUB_ENV
              exit 0
            fi
            sleep 10
          done
          echo "STATUS=timeout" >> $GITHUB_ENV

      - name: Send Discord Notification
        if: always()
        run: |
          # Metadata
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA=${COMMIT_SHA:0:7}

          # Handle missing environment variables
          [ -z "$STATUS" ] && STATUS="error"
          [ -z "$DEPLOY_URL" ] && DEPLOY_URL="https://github.com/$REPO/actions"

          # Generate JSON payload using Python
          JSON_STRING=$(python3 -c '
          import os, json

          status = os.environ.get("STATUS", "error")
          color = 5763719 if status == "success" else 15548997
          title = "‚úÖ Deployment Successful" if status == "success" else "‚ùå Deployment Failed/Issue"

          payload = {
              "username": "Cloudflare Pages",
              "avatar_url": "https://brand.cloudflare.com/static/assets/logos/pages-icon-blue.png",
              "embeds": [{
                  "title": title,
                  "color": color,
                  "url": os.environ.get("DEPLOY_URL"),
                  "fields": [
                      {"name": "Project", "value": os.environ.get("CF_PROJECT", "N/A"), "inline": True},
                      {"name": "Status", "value": status, "inline": True},
                      {"name": "Author", "value": "'$ACTOR'", "inline": True},
                      {"name": "Commit", "value": "'$SHORT_SHA'", "inline": True},
                      {"name": "Link", "value": f"[Visit]({os.environ.get("DEPLOY_URL")})", "inline": False}
                  ],
                  "footer": {"text": "Via GitHub Actions (Diagnostic Polling)"}
              }]
          }
          print(json.dumps(payload))
          ')

          curl -H "Content-Type: application/json" -X POST -d "$JSON_STRING" "$DISCORD_WEBHOOK"
