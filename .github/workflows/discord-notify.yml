name: Discord Notification

on:
  status:

jobs:
  notify:
    # Run only when context is 'Cloudflare Pages' and state is success/failure
    if: "contains(github.event.context, 'Cloudflare Pages') && (github.event.state == 'success' || github.event.state == 'failure')"
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Webhook
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ github.event.state }}
          TARGET_URL: ${{ github.event.target_url }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          COMMIT_MSG: ${{ github.event.commit.commit.message }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "Error: DISCORD_WEBHOOK secret is missing!"
            exit 1
          fi

          if [ "$STATUS" == "success" ]; then
            COLOR=5763719  # Green
            TITLE="✅ Deployment Successful"
          else
            COLOR=15548997 # Red
            TITLE="❌ Deployment Failed"
          fi

          # Safe string handling
          REPO="${REPO//\"/\\\"}"
          ACTOR="${ACTOR//\"/\\\"}"
          TARGET_URL="${TARGET_URL//\"/\\\"}"

          # Construct JSON payload
          PAYLOAD=$(cat <<EOF
          {
            "username": "Cloudflare Pages",
            "avatar_url": "https://brand.cloudflare.com/static/assets/logos/pages-icon-blue.png",
            "embeds": [{
              "title": "$TITLE",
              "color": $COLOR,
              "url": "$TARGET_URL",
              "fields": [
                { "name": "Project", "value": "$REPO", "inline": true },
                { "name": "Status", "value": "$STATUS", "inline": true },
                { "name": "Visit Preview", "value": "[Click Here]($TARGET_URL)", "inline": false }
              ],
              "footer": {
                "text": "Via GitHub Actions (Status Check)"
              },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          # Send to Discord
          curl -H "Content-Type: application/json" -X POST -d "$PAYLOAD" "$DISCORD_WEBHOOK"
