name: Discord Notification

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CF_PROJECT: ${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}
      CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: Verify and Sanitize Secrets (Python)
        shell: python
        run: |
          import os

          # GitHub SecretsÏóêÏÑú Í∞íÏùÑ Í∞ÄÏ†∏ÏôÄ ÏïûÎí§ Í≥µÎ∞±/Ï§ÑÎ∞îÍøà ÏôÑÎ≤Ω Ï†úÍ±∞
          def clean(val):
              return val.strip() if val else ""

          secrets = {
              "CF_ACCOUNT_ID": clean("""${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"""),
              "CF_PROJECT": clean("""${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}"""),
              "CF_TOKEN": clean("""${{ secrets.CLOUDFLARE_API_TOKEN }}"""),
              "DISCORD_WEBHOOK": clean("""${{ secrets.DISCORD_WEBHOOK_URL }}""")
          }

          # ÌïÑÏàò Í∞íÏù¥ ÎπÑÏñ¥ÏûàÎäîÏßÄ Ï≤¥ÌÅ¨
          for key, value in secrets.items():
              if not value:
                  print(f"‚ùå ERROR: {key} is empty! Check your GitHub Secrets names.")
                  exit(1)

          # GITHUB_ENVÏóê Ï†ÄÏû•ÌïòÏó¨ Îã§Ïùå Îã®Í≥ÑÏóêÏÑú ÏÇ¨Ïö©ÌïòÍ≤å Ìï®
          with open(os.environ["GITHUB_ENV"], "a") as f:
              for key, value in secrets.items():
                  f.write(f"{key}={value}\n")

          print("‚úÖ All secrets sanitized and loaded.")

      - name: Token Diagnostics
        run: |
          echo "üîç Checking Cloudflare Token validity..."
          VERIFY=$(curl -s -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" \
            -H "Authorization: Bearer $CF_TOKEN" \
            -H "Content-Type: application/json")

          if [[ $VERIFY != *"\"status\":\"active\""* ]]; then
            echo "‚ùå ÌÜ†ÌÅ∞ Ïù∏Ï¶ù Ïã§Ìå®! CloudflareÍ∞Ä ÌÜ†ÌÅ∞ÏùÑ Ïù∏ÏãùÌïòÏßÄ Î™ªÌï©ÎãàÎã§."
            echo "Response: $VERIFY"
            echo "ÌûåÌä∏: ÌÜ†ÌÅ∞ ÏÉùÏÑ± Ïãú IP Ï†úÌïúÏù¥ Í±∏Î†§ÏûàÏßÄ ÏïäÏùÄÏßÄ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî."
            exit 1
          fi
          echo "‚úÖ Token is active and valid!"

      - name: Wait for Cloudflare
        run: sleep 30

      - name: Poll Deployment Status
        id: poll
        shell: bash
        run: |
          set +e
          API_BASE="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PROJECT}"

          echo "üîç Attempting to access project: $CF_PROJECT"
          DETAILS=$(curl -s -X GET "$API_BASE/deployments?per_page=1" \
            -H "Authorization: Bearer $CF_TOKEN")

          if [[ $DETAILS == *"\"success\":false"* ]]; then
            echo "‚ùå ÌîÑÎ°úÏ†ùÌä∏ Ï†ëÍ∑º Í±∞Î∂Ä (403 Forbidden)!"
            echo "API Response: $DETAILS"
            exit 1
          fi

          DEPLOY_ID=$(echo "$DETAILS" | jq -r '.result[0].id')
          if [ "$DEPLOY_ID" == "null" ]; then
            echo "‚ùå No deployments found."
            exit 1
          fi
          echo "üìå Tracking Deployment ID: $DEPLOY_ID"

          for i in {1..30}; do
            STATUS_RESP=$(curl -s -X GET "$API_BASE/deployments/$DEPLOY_ID" -H "Authorization: Bearer $CF_TOKEN")
            STATUS=$(echo "$STATUS_RESP" | jq -r '.result.latest_stage.status')
            URL=$(echo "$STATUS_RESP" | jq -r '.result.url')
            echo "   Status ($i/30): $STATUS"
            
            if [[ "$STATUS" == "success" || "$STATUS" == "failure" ]]; then
              echo "STATUS=$STATUS" >> $GITHUB_ENV
              echo "DEPLOY_URL=$URL" >> $GITHUB_ENV
              exit 0
            fi
            sleep 10
          done
          echo "STATUS=timeout" >> $GITHUB_ENV

      - name: Send Discord Notification
        if: always()
        run: |
          # Metadata
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          COMMIT_SHA Heather="${{ github.sha }}"
          SHORT_SHA=${COMMIT_SHA:0:7}

          [ -z "$STATUS" ] && STATUS="error"
          [ -z "$DEPLOY_URL" ] && DEPLOY_URL="https://github.com/$REPO/actions"

          # Use Python for reliable JSON generation
          JSON_STRING=$(python3 -c '
          import os, json

          status = os.environ.get("STATUS", "error")
          color = 5763719 if status == "success" else 15548997
          title = "‚úÖ Î∞∞Ìè¨ ÏÑ±Í≥µ" if status == "success" else "‚ùå Î∞∞Ìè¨ Ïã§Ìå®/Ïò§Î•ò"

          payload = {
              "username": "Cloudflare Pages",
              "avatar_url": "https://brand.cloudflare.com/static/assets/logos/pages-icon-blue.png",
              "embeds": [{
                  "title": title,
                  "color": color,
                  "url": os.environ.get("DEPLOY_URL"),
                  "fields": [
                      {"name": "Project", "value": os.environ.get("CF_PROJECT", "N/A"), "inline": True},
                      {"name": "Status", "value": status, "inline": True},
                      {"name": "Author", "value": "'$ACTOR'", "inline": True},
                      {"name": "Commit", "value": "'$SHORT_SHA'", "inline": True},
                      {"name": "Link", "value": f"[Visit]({os.environ.get("DEPLOY_URL")})", "inline": False}
                  ],
                  "footer": {"text": "Via GitHub Actions (Python Sanitized)"}
              }]
          }
          print(json.dumps(payload))
          ')

          curl -H "Content-Type: application/json" -X POST -d "$JSON_STRING" "$DISCORD_WEBHOOK"
