name: Discord Notification

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CF_PROJECT: ${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}
      CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CF_EMAIL: ${{ secrets.CLOUDFLARE_EMAIL }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: Verify and Sanitize Secrets (Python)
        shell: python
        run: |
          import os

          def clean(val):
              return val.strip() if val else ""

          # Clean all secrets
          id_clean = clean("""${{ secrets.CLOUDFLARE_ACCOUNT_ID }}""")
          proj_clean = clean("""${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}""")
          token_clean = clean("""${{ secrets.CLOUDFLARE_API_TOKEN }}""")
          email_clean = clean("""${{ secrets.CLOUDFLARE_EMAIL }}""")
          webhook_clean = clean("""${{ secrets.DISCORD_WEBHOOK_URL }}""")

          # Save to Env
          with open(os.environ["GITHUB_ENV"], "a") as f:
              f.write(f"CF_ACCOUNT_ID={id_clean}\n")
              f.write(f"CF_PROJECT={proj_clean}\n")
              f.write(f"CF_TOKEN={token_clean}\n")
              f.write(f"CF_EMAIL={email_clean}\n")
              f.write(f"DISCORD_WEBHOOK={webhook_clean}\n")

          print(f"‚úÖ Cleaned secrets loaded. Token Length: {len(token_clean)}")

      - name: Poll Deployment Status
        id: poll
        shell: bash
        run: |
          set +e
          # Determine auth header (Global Key uses X-Auth-Key/Email, Token uses Bearer)
          if [[ -n "$CF_EMAIL" ]]; then
            echo "üîê Using Global API Key Authentication..."
            AUTH_HEADER="-H 'X-Auth-Email: $CF_EMAIL' -H 'X-Auth-Key: $CF_TOKEN'"
          else
            echo "üîê Using API Token (Bearer) Authentication..."
            AUTH_HEADER="-H 'Authorization: Bearer $CF_TOKEN'"
          fi

          API_BASE="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PROJECT}"

          # 1. Access Check with eval to handle dynamic headers safely
          DETAILS=$(eval "curl -s -X GET '$API_BASE/deployments?per_page=1' $AUTH_HEADER")

          if [[ $DETAILS == *"\"success\":false"* ]]; then
            echo "‚ùå API Access Failed! Response: $DETAILS"
            exit 1
          fi

          DEPLOY_ID=$(echo "$DETAILS" | jq -r '.result[0].id')
          if [ "$DEPLOY_ID" == "null" ] || [ -z "$DEPLOY_ID" ]; then
            echo "‚ùå No deployments found."
            exit 1
          fi
          echo "‚úÖ Project found. Deployment ID: $DEPLOY_ID"

          # 2. Poll Loop
          for i in {1..30}; do
            STATUS_RESP=$(eval "curl -s -X GET '$API_BASE/deployments/$DEPLOY_ID' $AUTH_HEADER")
            STATUS_VAL=$(echo "$STATUS_RESP" | jq -r '.result.latest_stage.status')
            URL_VAL=$(echo "$STATUS_RESP" | jq -r '.result.url')
            echo "   Status ($i/30): $STATUS_VAL"
            
            if [[ "$STATUS_VAL" == "success" || "$STATUS_VAL" == "failure" ]]; then
              echo "STATUS=$STATUS_VAL" >> $GITHUB_ENV
              echo "DEPLOY_URL=$URL_VAL" >> $GITHUB_ENV
              exit 0
            fi
            sleep 10
          done
          echo "STATUS=timeout" >> $GITHUB_ENV

      - name: Send Discord Notification
        if: always()
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          # Safe Metadata
          COMMIT_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)

          python3 -c '
          import os, json, requests

          status = os.environ.get("STATUS", "error")
          color = 5763719 if status == "success" else 15548997
          title = "‚úÖ Î∞∞Ìè¨ ÏÑ±Í≥µ" if status == "success" else "‚ùå Î∞∞Ìè¨ Ïã§Ìå®/Ïò§Î•ò"

          # Get commit message and truncate to first line
          commit_msg = os.environ.get("COMMIT_MSG") or "Manual Trigger / Dispatch"
          commit_msg_first_line = commit_msg.split("\n")[0][:100] # Max 100 chars for safety

          payload = {
              "username": "Cloudflare Pages",
              "avatar_url": "https://brand.cloudflare.com/static/assets/logos/pages-icon-blue.png",
              "embeds": [{
                  "title": title,
                  "color": color,
                  "url": os.environ.get("DEPLOY_URL", ""),
                  "fields": [
                      {"name": "Project", "value": os.environ.get("CF_PROJECT", "N/A"), "inline": True},
                      {"name": "Status", "value": status, "inline": True},
                      {"name": "Author", "value": "${{ github.actor }}", "inline": True},
                      {"name": "Commit", "value": f"[`{COMMIT_SHORT}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})", "inline": True},
                      {"name": "Message", "value": commit_msg_first_line, "inline": False}
                  ],
                  "footer": {"text": "Via GitHub Actions (Multi-Auth Support)"}
              }]
          }
          requests.post(os.environ["DISCORD_WEBHOOK"], json=payload)
          '
