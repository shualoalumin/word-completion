name: Discord Notification

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CF_PROJECT: ${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}
      CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
      - name: Wait for Cloudflare to start build
        run: |
          echo "‚è≥ Waiting 30 seconds for Cloudflare to pick up the changes..."
          sleep 30

      - name: Poll Deployment Status (Robust)
        id: poll
        shell: bash
        run: |
          # Disable immediate exit to handle errors manually
          set +e

          # Helper function for API calls
          call_cf_api() {
            local url="$1"
            local method="${2:-GET}"
            
            # Request with HTTP code at the end
            RESPONSE=$(curl -s -w "\n%{http_code}" -X "$method" \
              -H "Authorization: Bearer ${CF_TOKEN}" \
              -H "Content-Type: application/json" \
              "$url")
            
            # Extract Body and Status Code
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            # Log for debugging (Masking sensitive tokens if any appeared, though they shouldn't)
            echo "URL: $url"
            echo "HTTP Code: $HTTP_CODE"
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
               echo "$BODY"
               return 0
            else
               echo "‚ùå API Error Response:"
               echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
               return 1
            fi
          }

          API_BASE="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PROJECT}"

          # 1. Health Check & Project Verification
          echo "üîç Verifying credentials and project..."
          PROJECT_INFO=$(call_cf_api "$API_BASE")
          if [ $? -ne 0 ]; then
            echo "üö® Critical Error: Failed to access Cloudflare Pages Project."
            echo "Check your CLOUDFLARE_ACCOUNT_ID, CLOUDFLARE_PAGES_PROJECT_NAME, and API Token permission."
            exit 1
          fi
          echo "‚úÖ Project found: $(echo "$PROJECT_INFO" | jq -r '.result.name')"

          # 2. Get Latest Deployment
          echo "üîç Fetching latest deployment..."
          DEPLOYMENTS=$(call_cf_api "$API_BASE/deployments?sort_by=created_on&sort_order=desc&per_page=1")
          if [ $? -ne 0 ]; then
             echo "üö® Failed to list deployments."
             exit 1
          fi

          DEPLOYMENT_ID=$(echo "$DEPLOYMENTS" | jq -r '.result[0].id')
          if [ "$DEPLOYMENT_ID" == "null" ] || [ -z "$DEPLOYMENT_ID" ]; then
             echo "‚ùå Error: API returned no deployments. Is this a new project?"
             exit 1
          fi
          echo "üìå Tracking Deployment ID: $DEPLOYMENT_ID"

          # 3. Poll Loop
          MAX_RETRIES=40  # 40 * 10s = 400s (approx 6.5 mins)
          COUNT=0
          FINAL_STATUS="unknown"
          FINAL_URL=""

          while [ $COUNT -lt $MAX_RETRIES ]; do
            echo "üîÑ Polling status [$COUNT/$MAX_RETRIES]..."
            
            DETAILS=$(call_cf_api "$API_BASE/deployments/$DEPLOYMENT_ID")
            if [ $? -ne 0 ]; then
               echo "‚ö†Ô∏è Transient API error, retrying..."
               sleep 5
               continue
            fi

            STATUS=$(echo "$DETAILS" | jq -r '.result.latest_stage.status')
            FINAL_URL=$(echo "$DETAILS" | jq -r '.result.url // ""')
            
            echo "   Current Status: $STATUS"

            if [ "$STATUS" == "success" ] || [ "$STATUS" == "failure" ] || [ "$STATUS" == "error" ]; then
              FINAL_STATUS="$STATUS"
              break
            fi
            
            sleep 10
            COUNT=$((COUNT+1))
          done

          if [ "$FINAL_STATUS" == "unknown" ]; then
            echo "‚ö†Ô∏è Timeout reached. Assuming unknown status."
          fi

          # Output to GitHub Env
          echo "STATUS=$FINAL_STATUS" >> $GITHUB_ENV
          echo "DEPLOY_URL=$FINAL_URL" >> $GITHUB_ENV

          # Explicitly exit 0 to proceed to notification step
          exit 0

      - name: Send Discord Notification
        if: always() # Run even if polling had issues, to report failures
        run: |
          # If STATUS is missing (script crashed early), set to error
          if [ -z "$STATUS" ]; then STATUS="script_error"; fi

          if [ "$STATUS" == "success" ]; then
            COLOR=5763719  # Green
            TITLE="‚úÖ Deployment Successful"
            DESC="New version is live!"
          elif [ "$STATUS" == "script_error" ]; then
             COLOR=15105570 # Orange
             TITLE="‚ö†Ô∏è Notification Script Error"
             DESC="Check GitHub Actions logs. Cloudflare API might be unreachable."
          else
            COLOR=15548997 # Red
            TITLE="‚ùå Deployment Failed"
            DESC="Build failed on Cloudflare."
          fi

          # Metadata
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_MSG="${COMMIT_MSG//\"/\\\"}"
          COMMIT_MSG=$(echo "$COMMIT_MSG" | head -n 1)

          if [ -z "$DEPLOY_URL" ]; then DEPLOY_URL="https://github.com/$REPO/actions"; fi

          PAYLOAD=$(cat <<EOF
          {
            "username": "Cloudflare Pages",
            "avatar_url": "https://brand.cloudflare.com/static/assets/logos/pages-icon-blue.png",
            "embeds": [{
              "title": "$TITLE",
              "description": "$DESC",
              "color": $COLOR,
              "url": "$DEPLOY_URL",
              "fields": [
                { "name": "Project", "value": "$REPO", "inline": true },
                { "name": "Commit", "value": "$COMMIT_MSG", "inline": true },
                { "name": "Author", "value": "$ACTOR", "inline": true },
                { "name": "Link", "value": "[Visit]($DEPLOY_URL)", "inline": false }
              ],
              "footer": { "text": "Via GitHub Actions (Robust Polling)" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" -X POST -d "$PAYLOAD" "$DISCORD_WEBHOOK"
