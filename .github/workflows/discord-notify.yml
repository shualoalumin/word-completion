name: Discord Notification

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CF_PROJECT: ${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}
      CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
      - name: Wait for Cloudflare Check
        run: |
          echo "Waiting 45 seconds for Cloudflare to initiate the build..."
          sleep 45

      - name: Poll Deployment Status
        id: poll
        run: |
          set -e
          API="https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${CF_PROJECT}/deployments"
          HEADERS=(-H "Authorization: Bearer ${CF_TOKEN}" -H "Content-Type: application/json")

          # 1. Get the very latest deployment
          echo "Fetching latest deployment..."
          LIST=$(curl -s "${HEADERS[@]}" "${API}?sort_by=created_on&sort_order=desc&per_page=1")
          DEPLOYMENT_ID=$(echo "$LIST" | jq -r '.result[0].id')

          if [ "$DEPLOYMENT_ID" == "null" ] || [ -z "$DEPLOYMENT_ID" ]; then
             echo "❌ Error: No deployments found at all."
             exit 1
          fi

          echo "Found latest deployment: $DEPLOYMENT_ID"

          # 2. Poll for completion
          echo "Polling status for deployment: $DEPLOYMENT_ID"

          MAX_RETRIES=30 # 30 * 10s = 300s (5 mins max wait)
          COUNT=0
          STATUS="unknown"

          while [ $COUNT -lt $MAX_RETRIES ]; do
            DEPLOY=$(curl -s "${HEADERS[@]}" "${API}/${DEPLOYMENT_ID}")
            STATUS=$(echo "$DEPLOY" | jq -r '.result.latest_stage.status')
            URL=$(echo "$DEPLOY" | jq -r '.result.url // ""')
            
            echo "[$COUNT] Current status: $STATUS"

            if [ "$STATUS" == "success" ] || [ "$STATUS" == "failure" ] || [ "$STATUS" == "error" ]; then
              break
            fi
            
            echo "Build in progress... waiting 10s"
            sleep 10
            COUNT=$((COUNT+1))
          done

          if [ "$STATUS" != "success" ] && [ "$STATUS" != "failure" ] && [ "$STATUS" != "error" ]; then
             echo "⚠️ Timeout waiting for build. Marking as unknown."
             STATUS="timeout"
          fi

          # Export variables for the next step
          echo "STATUS=$STATUS" >> $GITHUB_ENV
          echo "DEPLOY_URL=$URL" >> $GITHUB_ENV

      - name: Send Discord Notification
        run: |
          if [ "$STATUS" == "success" ]; then
            COLOR=5763719  # Green
            TITLE="✅ Deployment Successful"
          else
            COLOR=15548997 # Red
            TITLE="❌ Deployment Failed"
          fi

          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_MSG="${COMMIT_MSG//\"/\\\"}" # Safe escape
          COMMIT_MSG=$(echo "$COMMIT_MSG" | head -n 1) # First line only

          # Build JSON
          PAYLOAD=$(cat <<EOF
          {
            "username": "Cloudflare Pages",
            "avatar_url": "https://brand.cloudflare.com/static/assets/logos/pages-icon-blue.png",
            "embeds": [{
              "title": "$TITLE",
              "color": $COLOR,
              "url": "$DEPLOY_URL",
              "fields": [
                { "name": "Project", "value": "$REPO", "inline": true },
                { "name": "Commit", "value": "$COMMIT_MSG", "inline": true },
                { "name": "Author", "value": "$ACTOR", "inline": true },
                { "name": "Visit Site", "value": "[Click here]($DEPLOY_URL)", "inline": false }
              ],
              "footer": { "text": "Via GitHub Actions Polling" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" -X POST -d "$PAYLOAD" "$DISCORD_WEBHOOK"
